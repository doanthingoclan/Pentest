Chương 7 : CÁC LỆNH LOGIC, DỊCH VÀ QUAY
-	Các lệnh logic AND , OR , XOR and NOT sử dụng để xóa, thiết lập và kiểm tra từng bit trong các thanh ghi hay các biến ( như đổi chữ thường thành hoa , kiểm tra thanh chứa số chẵn hay lẻ).
-	Các lệnh dịch : các bít được dịch phải or trái ; khi bit bị dịch ra nó sẽ chứa cờ CF . Vì dịch trái là nhân đôi số và dịch phải là chia đôi nó cho phép chúng ta thực hiện phép nhân và chia một lũy thừa của 2 .
-	Các lệnh quay làm việc giống như các lệnh dịch ( expert:  nếu 1 bit bị ra khỏi 1 phía toán hạng nó sẽ đc đưa trở về phía kia của toán hạng) . Được sử dug nếu muốn kt or thay đổi các bit .
1.	Các lệnh LOGIC
VD 1: Thực hiện thao tác logic :
1.	10101010 AND  11110000
2.	10101010	OR	11110000
3.	10101010	XOR	11110000
4.	NOT	10101010
Trả lời :
1.	 
		10101010
	AND	11110000
	-----------------------
	=	10100000
      2.
			10101010
		OR	11110000
		-----------------------
		=	11111010
     3.
			10101010
		XOR	11110000
		----------------------
		=	01011010
4.
			10101010
		------------------------
		NOT	01010101
a.	Các lệnh AND,OR và XOR
Cú pháp : 
AND	Đích , nguồn
OR	Đích, nguồn
XOR	Đích, nguồn

Kết quả của thao tác được chứa trong toán hạng đích ; toán hạng nguồn có thể là hằng số . Tuy nhiên các thao tác giữa 2 ô nhớ là không hợp lệ
Ảnh hưởng tới cờ :
	SF, ZF, PF phản ánh kết quả của lệnh
	AF không xác định
	CF, OF = 0
Khi sử dụng các lệnh trên ta có thể thay đổi có chọn lọc các bit . Để làm được chúng ta tạo lên mẫu bit “mặt nạ” (MASK) , các bít này được chọn để các bit t/ứ của toán hạng đích thay đổi đúng như ta mong muốn .
Để chọn được mặt nạ chúng ta sử dụng các t/c sau :
	b 	AND	1	= b , b	OR	0 = b,	b	XOR	0 = b
 	b 	AND	1	= b , b	OR	1 =1,	b	XOR	1 = ~b ( bù của b )
Kết luận :
-	AND sử dụng để xóa các bit nhất định trong khi giữ nguyên những bit còn lại. Bit 0 của MASK xóa bit t/ứ,  còn bit 1 giữ nguyên bit t/ứ của toán hạng đích .
-	OR dùng để thiết lập các bit xác định của toán hạng đích trong khi vẫn giữ nguyên những bit còn lại. Bit 1 của mặt nạ sẽ thiết lập bit t/ứ , bit 0 sẽ giữ nguyên bit t/ứ .
-	XOR dùng để đảo các bit xác định trong khi vẫn giữ nguyên những bit còn lại. Bit 1 của mặt nạ làm đảo bit còn bit 0 giữ nguyên bit t/ứ .
VD 2: Xóa bit dấu của AL trong khi giữ nguyên các bit còn lại .
TL : Sử dụng lệnh AND với 0111111b = 7Fh làm mặt nạ : AND	AL, 7Fh
VD3 : Thiết lập các bit trọng lượng cao nhất và thấp nhất của AL trong khi giữ nguyên các bit còn lại .
TL : Sử dụng lệnh OR với 10000001b = 81h làm mặt nạ : OR	AL,81h
VD 4: Thay đổi bit dấu của DX
TL : Sử dụng lệnh XOR với mặt nạ 8000h : XOR	DX,8000h
Chú ý : Để tránh nhầm lẫn khi viết, tốt nhất nên biểu diễn mặt nạ dưới dạng số hex thay vì dưới dạng nhị phân đặc biệt là khi sử dụng mặt nạ dài 16 bit .
Các lệnh logic đặc biệt có ích khi thực hiện các công việc :
•	Đổi mã ASCII của một số thanh số t/ứ .
Để nhận được 5 thay vì 35h trong thanh ghi  AL chúng ta làm như sau :

SUB	AL, 30h
Một phương pháp khác là sử dụng lệnh AND để xóa nửa byte cao của AL :
		AND	AL, 0Fh
Phương pháp này có thể dùng để đổi mã ASCII của bất cứ chữ số nào thành giá trị thập phân tường ứng .
Sử dụng AND thay SUB chúng ta nhấn mạnh rằng chúng ta thay đổi những mẫu bit của AL, làm cho ct dễ đọc hơn . 

•	Đổi chữ thường thành chữ hoa .
Lệnh : 
	SUH	AL,20h

Ký tự		Mã ASCII	Ký tự		Mã ASCII
a    		01100001	A		01000001
b    		01100010	B		01000010
.		        .		.		         .
.		        .		.		         .
.		        .		.		         .
a    		01100001	A		01000001

Để đổi chữ thường thành chữ hoa chỉ cần xóa bit 5, có thể thực hiện bằng cách dùng lệnh AND với mặt na 11011111b hay 0DFh . Nếu một chữ thường chứa trong DL, ta có lệnh sau : 
		AND		DL,0DFh
•	Xóa một thanh ghi
Cú pháp :
	MOV		AX,0
Hay
	SUB		AX,AX
Bằng các sử dụng một tính chất :  1	XOR	1   = 0  và 0 	XOR	0  =  0 có phương pháp sau :
	XOR		AX,AX
Mã máy lệnh đầu tiên là 3 byte so với 2 byte , như vậy các lệnh sau hiệu quả hơn. Tuy nhiên các thao tác giữa ô nhớ với ô nhớ là không hợp lệ nên khi cần xóa một ô nhớ thì phải sử dụng lệnh thứ nhất .
•	Kiểm tra xem một thanh ghi có bằng 0 hay không
Vì 	1	OR	1 	=  1  và 0	OR	0  =  0 nếu thực hiện sẽ phí thời gian. Có lệnh sau :
		OR	CX,CX

Chúng không làm thay đổi nội dung của CX, nhưng lại tác động đến cờ ZF và SF do đó khi CX chứa 0 thì ZF =1 và vì vậy có thể thay cho lệnh :
		CMP	CX,0
Để kiểm tra nội dung có bằng 0 hay không hoặc để kiểm tra dấu của số chứa trong thanh ghi .
b.	Lệnh NOT
NOT lấy số bù 1 của một toán hạng đích. Cú pháp :
	NOT	toán hạng đich
Lệnh này không làm ảnh hưởng tới các cờ .
VD 5: Đảo các bit trong thanh ghi AX 
Trả lời :
	Dùng lệnh NOT :
		NOT	AX
c.	Lệnh TEST .
-	Lệnh thực hiện thao tác và logic giữa các toán hạng đích với nguồn nhưng không thay đổi toán hạng đích. Mục đích : thiết lập các cờ .
Cú pháp :
	TEST	toán hạng đích, toán hạng nguồn
Các cờ bị tác động :
	SF,ZF,PF phản ánh kết quả
	AF không xác định
	CF,OF =0
Kiểm tra các bit
Mặt nạ có giá trị 1 ở các bit tương ứng với các bit cần kiểm tra trong toán hạng đích và giá trị 0 ở các bit khác. Vì 	1	AND	b  =  b  và 	0	AND	b  =  0 kết quả của lệnh :
TEST	toán hạng đích , mặt nạ
Có giá trị 1 ở các bit khi và chỉ khi toán hạng đích có gt 1 , còn lại các bit khác có gt 0
Nếu toán hạng đích có gt 0 ở all bits được kiểm tra thì KQ = 0 và ZF = 1 .
VD 6 : Viết đoạn lệnh thực hiện nhảy đến nhãn BELOW nếu AL chứa số chẵn .
TL : Vì các số chẵn có bit 0 =0 nên MASK là 00000001b  =  1 . Có :
	TEST	AL,1		; AL chứa sô chẵn ?
	JZ	BELOW		;Đúng ! , nhảy đến BELOW
2.	Các lệnh dịch .
Các lệnh dịch và quay dịch các bit sang trái or phải một or một số vị trí . Đối với lệnh dịch các bit bị dịch ra khỏi toán hạng sẽ bị mất, còn đối với lệnh quay các bit dịch ra khỏi một phía của toán hạng sẽ được đưa trở lại phía kia. Có 2 dạng :
-	Khi muốn dịch or quay 1 vị trí:
Mã lệnh 		toán hạng đích , 1
-	Khi muốn dịch or quay N vị trí :
Mã lệnh		toán hạng đích , CL
Trong CL chứa N , trong cả 2 TH toán hạng đích là thanh ghi 8 or 16 bit hay là một ô nhớ . Các lệnh này có thể dùng để nhân or chia cho lũy thừa của 2, và được sử dụng trong các chương trình vào ra với số nhị phân và hex .
a)	Các lệnh dịch trái
Lệnh SHL ( shift left) .
Dịch các bit sang bên trái. Cú pháp cho lệnh dịch một vị trí :
	SHL	toán hạng đích , 1	
0 sẽ được đưa vào vị trí bên phải nhất, còn msg sẽ dược đưa vào cờ CF .
Nếu số đếm vị trí dịch N khác 1 thì lệnh có dạng :
	SHL	toán hạng đích , CL
N phép dịch trái đơn được thực hiện. Giá trị CL giữ nguyên không thay đổi khi thực hiện xong .
Các cờ bị tác động :
	SF, PF, ZF phản ánh kết quả
	AF không xác định
	CF chứa bit cuối cùng được dịch ra khỏi toán hạng
	OF =1 nếu KQ bị thay đổi dấu trong phép dịch cuối.
VD 7 : DH = 8Ah và CL = 3, giá trị của DH và CF sau khi lệnh 	SHL	DH, CL thực hiện.
TL : GT nhị phân DH = 10001010, sau 3 lần dịch CF sẽ chứa 0 còn nội dung nhận được bằng cách xóa đi 3 bit bên trái nhất của DH và them 3 bit 0 vào bên 0 phải nó. KQ : 01010000b = 50h 
Thực hiện phép nhân bằng cách dịch trái .
Việc dịch trái một số nhị phân cũng như nhân nó với 2. 
VD: AL chứa 5 = 00000101b . Sau khi dịch trái 1 bit : 00001010b = 10d nghĩa là = 2 giá trị của nó. Tiếp tục dịch trái 00010100b = 20d nghĩa là lại nhân đổi nó một lần nữa . 
Lệnh SAL
	Lệnh SHL : nhân một toán hạng với lũy thừa 2
	Lệnh SAL : làm nổi bật bản chất số học của thao tác thường đc sử dụng để thay cho việc nhân các số
	Cả 2 lệnh đều tạo ra cùng một mã máy
	Các số âm cũng có thể được nhân 2 bằng cách dịch trái . VD : AX = FFFh (-1) dịch trái nó 3 bit thì sẽ nhận được AX = FFF8h ( -8 )
Sự tràn
VD 8: Viết một đoạn lênh thực hiện phép nhân AX với 8, giả sử hiện tượng tràn không xảy ra .
TL : 
	Để thực hiện phep nhân với 8 chúng ta cần 3 lần dịch trái :
		MOV	CL,3	; Số lần dịch
		SHL	AX, CL	; Nhân với 8
b)	Các lệnh dịch phải
Lệnh SHR ( shift Right )
Dịch các bit của toán hạng đích sang bên phải . Cú pháp dịch 1 vị trí :
	SHR	toán hạng đích , 1
Một GT 0 sẽ được đưa vào bit msb, còn bit bên phải nhất của nó ( lsb ) sẽ được đưa vào CF . Nếu số đếm vị trí khác 1 thì có lệnh :
	SHL	toán hạng đích , CL
N phép dịch đơn được thực hiện. Giá trị của CL vẫn giữ nguyên không thay đổi khi thực hiện xong . Các cờ bị tác động cũng giống như trong TH dịch trái .
VD 9 : DH = 8Ah và CL =2, cho biết giá trị DH và CF sau khi thực hiện lệnh : SHL	DH,CL .
TL : 	
	Giá trị nhị phân trong DH là 10001010. Sau 2 lần dịch CF = 1 còn DH có thể nhận được bằng cách xóa đi 2 bit bên phải nhất của DH và them 2 bit 0 vào bên 0 phải nó. KQ : 00100010b = 22h
Lệnh SAR ( shift arimethic right )
Giống lênh SHR với 1 điểm khác biệt là bit msb của toán hạng đích giữ nguyên giá trị ban đầu của nó . Cú pháp :
	SAR	toán hạng đích, 1
	SAR	Toán hạng đích , CL
Các cờ bị tác động giống như SHR
Thực hiện phép chia bằng cách dịch phải .
Đối với các số chẵn sẽ chia đôi giá trị của toán hạng đích. Còn với các số lẻ, dịch phải sẽ chia đôi nó và làm tròn xuống số nguyên gần nhất. 
VD: nếu BL chứa 00000101b = 5 thì sau khi dich phải BL sẽ chứa 0000010 = 2 .
Phép chia không dấu và có dấu
Với các số không dấu, sử dụng lệnh SHR còn với số có dấu sử dụng lệnh SAR vì lệnh này giữ nguyên dấu .

VD 10 :  Sử dụng các phép dịch phải để thực hiện phép chia số không dấu 65143 cho 4, thương số chứa trong AX
TL : Để chia 4 cần dịch phải 2 lần, do số bị chia là số không dấu nên sử dụng lệnh SHR 
	MOV	AX,65143	; AX chứa số bị chia
	MOV	CL, 2		; CX chứa số lần dịch phải
	SHR	AX, CL		; chia cho 4
VD 11 : AL chứa -15 , giá trị thập phân của AL sau khi thực hiện lệnh SAR		AL, 1
TL :
 Lệnh trên chia số cho 2 và làm tròn xuống .
	Chia -15 cho 2 nhận được -7,5 làm tròn bằng -8
	Dưới dạng sô nhị phân -15 = 11110001b . Sauk hi dịch phải chúng ta có 1111100b = -8
3.	Các lệnh quay
Lệnh quay trái (rorate left)
Lệnh dịch các bit sang bên trái . Bit msb được dịch vào bit bên phải nhất, và đưa vào cờ CF . Các bit của toán hạng đích tạo thành một vòng trogn với bit lsb theo sau bit msb . Cú pháp :
	ROL	toán hạng đích , 1
	ROL	toán hạng đích, CL
Lệnh quay phải
Giống như ROL, ngoại trừ là các bit được dịch sang phải, bit bên phải nhất được dịch vào bit msb đồng thời đưa vào CF . Cú pháp :
	ROR	toán hạng đích , 1
Và
	ROR	toán hạng đích , CL
	
Lệnh ROL, ROR cờ CF chứa bit bị dịch ra khỏi toán hạng
VD 12: Sử dụng ROL để đếm số bit 1 trog thanh ghi BX mà không làm thay đổi nội dung của nó, chứa kết quả trong AX .
TL : 
	XOR	AX, AX		; AX đếm sô bit
	MOV	CX, 16		; Biến đếm vòng lặp
TOP:
	ROL	BX, 1		; CF chứa bit bị đưa ra
	JNC	NEXT		; bit 0 ?
	INC	AX		; không phải !, tăng số bit 1
NEXT:
	LOOP	TOP		; lặp lại cho đến khi làm xong
Lệnh quay trái qua cờ nhớ
Lệnh RCL ( Rotate Carry Left ) dịch các bit của toán hạng đích sang trái . Bit msb được đặt vào CF, giá trị cũ đưa vào bit phải nhất của toán hạng đích .
RCL làm việc giống ROL , expert : cờ CF cũng là một phần của vòng tròn tạo lên bởi các bit đg được quay . Cú pháp :
	RCL	toán hạng đích , 1
Và
	RCL	toán hạng đích, CL
Lệnh quay phải qua cờ nhớ
Lệnh RCR ( Rotate Carry Right ) hđ giống RCL, nhưng các bit được quay sang phải. Cú pháp :
	RCR	toán hạng đích , 1
Và
	RCR	toán hạng đích , CL

VD 13 : DH chứa 8Ah, CF =1 và CL chứa 3. Nội dung của DH và CF khi thực hiện RCR 	DH,CL ?
TL :
				CF		DH
Các giá trị đầu		1	         10001010
Sau 1 lần dịch		0	         11000101
Sau 2 lần dịch		1	          01100010
Sau 3 lần dịch		0	          10110001
KQ : DH chứa 10110001b = B1h

Tác động của các lệnh quay đến cờ
	SF, PF, ZF phản ánh kết quả
	AF không xác định
	CF = bit cuối cùng bị dịch ra khỏi toán hạng
	OF = 1 nếu kết quả đổi dấu trong lần quay cuối cùng
Một ứng dụng : Đảo các mẫu bit
Chẳng hạn AL chứa 11011100 đổi thành 00111011. Phương pháp : lệnh SHL dịch các bit ra khỏi đầu bên trái của AL rồi dùng lệnh RCR đưa nó vào đầu bên trái của thanh ghi khác như BL . Sauk hi lặp lại công việc đó 8 lần BL sẽ chứa mẫu bit đã đảo ngược của AL và chép lại nội dụng của nó vào AL . Đoạn lệnh :
	MOV		CX, 8		; Số lần cần thực hiện
REVERSE :
	SHL		AL, 1		; lấy bit vào CF
	RCR		BL , 1 		; Quay để đưa nó vào BL
	LOOP		RESERVE	; lặp cho đến khi DO xong
	MOV		AL, BL		; AL chứa mẫu bit đảo ngược














































































































